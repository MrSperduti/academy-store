<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - ACADEMY STORE</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    window.onload = function () {
      emailjs.init("6UvRqFZl_DySz_084");
    };
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Checkout</h1>
    <nav><a href="prodotti.html">üîô Torna al catalogo</a></nav>
  </header>
  <main>
    <form id="checkout-form" style="max-width: 400px; margin: auto;" onsubmit="inviaOrdine(); return false;">
      <label>Nome:<br><input type="text" id="nome" required></label><br><br>
      <label>Cognome:<br><input type="text" id="cognome" required></label><br><br>
      <label>Data di nascita:<br><input type="date" id="datanascita" required></label><br><br>
      <label>Email:<br><input type="email" id="email" required></label><br><br>
      
      <label>Descrivi come vuoi la tua personalizzazione:</label><br>
      <textarea id="note" rows="4" placeholder="Scrivi qui le istruzioni per la personalizzazione..."></textarea><br><br>
      
      <button type="submit">üì© Invia ordine</button>
    </form>
    <pre id="debug-output" style="margin-top:20px; background:#eee; padding:10px;"></pre>
  </main>
  <script>
    function generaRiepilogoCarrello() {
      const carrello = JSON.parse(localStorage.getItem("carrello")) || [];
      if (carrello.length === 0) return "Carrello vuoto.";

      let totale = 0;
      let supplemento = 0;
      let riepilogo = "";

      carrello.forEach(p => {
        let prezzoProdotto = p.prezzo * p.quantita;
        let haAggiuntaScritta = p.aggiungiScritta && p.aggiungiScritta.trim() !== "";

        if (haAggiuntaScritta) {
          supplemento += 2 * p.quantita; // 2 euro per ogni prodotto con aggiunta scritta, moltiplicato per quantit√†
        }

        totale += prezzoProdotto;

        riepilogo += `üîπ ${p.nome}
${p.taglia ? "- Taglia: " + p.taglia : ""}
${p.colore ? "- Colore: " + p.colore : ""}
${p.modificaScritta ? "- Modifica scritta: " + p.modificaScritta : ""}
${p.aggiungiScritta ? "- Aggiunta scritta: " + p.aggiungiScritta : ""}
${p.posizioneScritta ? "- Posizione personalizzazione: " + p.posizioneScritta : ""}
- Quantit√†: ${p.quantita}
- Prezzo: ‚Ç¨${p.prezzo.toFixed(2)}
- Subtotale: ‚Ç¨${prezzoProdotto.toFixed(2)}

`;
      });

      if (supplemento > 0) {
        riepilogo += `‚ûï Supplemento aggiunta scritta: ‚Ç¨${supplemento.toFixed(2)}\n\n`;
      }

      riepilogo += `üí∞ Totale: ‚Ç¨${(totale + supplemento).toFixed(2)}`;

      return riepilogo;
    }

    function inviaOrdine() {
      const templateParams = {
        nome: document.getElementById("nome").value,
        cognome: document.getElementById("cognome").value,
        datanascita: document.getElementById("datanascita").value,
        email: document.getElementById("email").value,
        note: document.getElementById("note").value,
        carrello: generaRiepilogoCarrello()
      };

      emailjs.send("service_px4g8mw", "template_qeoslbr", templateParams)
        .then(response => {
          document.getElementById("debug-output").textContent = "‚úÖ Ordine inviato con successo! Grazie per aver ordinato con ACADEMY STORE.\nPotrai ritirare il tuo ordine presso il nostro store in via Venezia 128, Ardea.\nRiceverai una mail quando sar√† pronto.";
          localStorage.removeItem("carrello"); 
          window.location.href = "ordine-completato.html";
        }, error => {
          document.getElementById("debug-output").textContent = "‚ùå Errore durante l'invio:\n" + JSON.stringify(error, null, 2);
        });
    }
  </script>
</body>
</html>
